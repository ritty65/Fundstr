name: Deploy staging (Develop2 â†’ Hostinger)

on:
  push:
    branches: [Develop2]
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch to deploy (must be Develop2)"
        required: true
        default: "Develop2"

permissions:
  contents: read

concurrency:
  group: staging-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_VERSION: 20
  PNPM_VERSION: 9
  OUTDIR: dist
  HOST: ${{ secrets.STAGING_HOST }}
  USER: ${{ secrets.STAGING_USER }}
  TARGET: ${{ secrets.STAGING_TARGET }}
  SSH_OPTS: "-o StrictHostKeyChecking=no -p ${{ secrets.STAGING_SSH_PORT }}"
  BUILD_SHA: ${{ github.sha }}

jobs:
  deploy:
    if: github.ref == 'refs/heads/Develop2' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Prepare SSH key
        run: |
          set -euo pipefail
          install -m 600 -D /dev/null ~/.ssh/id_ed25519
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/id_ed25519
          ssh-keyscan -p "${{ secrets.STAGING_SSH_PORT }}" "${{ env.HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy via rsync
        run: |
          set -euo pipefail
          rsync -az --delete -e "ssh $SSH_OPTS" "$OUTDIR/" "${USER}@${HOST}:${TARGET}/"

      - name: Smoke test staging (edge-resilient)
        env:
          BASE_URL: https://staging.fundstr.me
        run: |
          set -euo pipefail
          if [[ -x scripts/smoke-tests.sh ]]; then
            scripts/smoke-tests.sh
          else
            curl -I -fsSL "${BASE_URL}/?t=${{ github.run_id }}#${{ github.sha }}" >/dev/null
          fi
