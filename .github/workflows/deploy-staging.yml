name: Deploy staging (Develop2 → Hostinger)

on:
  push:
    branches: [ Develop2 ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch to deploy (must be Develop2)'
        required: true
        default: 'Develop2'

permissions:
  contents: read

# Avoid concurrent deploys clobbering each other
concurrency:
  group: deploy-staging-develop2
  cancel-in-progress: true

jobs:
  deploy:
    # Guard rail: only allow Develop2 when manually triggered
    if: github.ref == 'refs/heads/Develop2' || github.event.inputs.ref == 'Develop2'
    runs-on: ubuntu-latest

    env:
      NODE_VERSION: '20'
      QUASAR_MODE: pwa         # change to 'spa' if your build emits dist/spa
      BUILD_SHA: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Enable pnpm via Corepack
        run: corepack enable

      - name: Install rsync + ssh-client
        run: sudo apt-get update && sudo apt-get install -y rsync openssh-client

      # Optional: inject a build id/environment if your app reads it
      - name: Set build id (optional)
        run: |
          echo "VITE_BUILD_SHA=${BUILD_SHA}" >> .env
          echo "BUILD_SHA=${BUILD_SHA}"

      # Optional: use a staging env file if present
      - name: Use staging env (optional)
        run: |
          if [ -f .env.staging ]; then
            cp .env.staging .env
          fi

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build (Quasar PWA)
        run: |
          if [ "${{ env.QUASAR_MODE }}" = "pwa" ]; then
            pnpm quasar build -m pwa
          else
            pnpm quasar build
          fi

      # Ensure .htaccess exists with sane cache rules (especially for sw.js)
      - name: Enforce .htaccess with cache headers (in built bundle)
        run: |
          OUTDIR="dist/${{ env.QUASAR_MODE }}"
          mkdir -p "$OUTDIR"
          cat > "$OUTDIR/.htaccess" <<'HTACCESS'
# Generated by CI: cache assets aggressively; never cache service worker
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresDefault "access plus 0 seconds"
  ExpiresByType text/html "access plus 0 seconds"
  ExpiresByType text/css "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType application/manifest+json "access plus 1 year"
  ExpiresByType application/font-woff2 "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
</IfModule>

<IfModule mod_headers.c>
  Header always set Vary "Accept-Encoding"
  <Files "sw.js">
    Header always unset Cache-Control
    Header always unset Expires
    Header always unset Pragma
    Header set Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0"
  </Files>
</IfModule>

<IfModule mod_rewrite.c>
  Options -MultiViews
  RewriteEngine On
  RewriteRule ^assets/ - [L]
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteRule ^ index.html [QSA,L]
</IfModule>
HTACCESS

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # SAFE HOST TRUST: prefer pinned key; else scan; clear errors if vars missing
      - name: Trust remote host (robust)
        shell: bash
        env:
          HOST:  ${{ secrets.SSH_HOST }}
          PORT:  ${{ secrets.SSH_PORT }}
          KNOWN: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          set -euo pipefail

          mkdir -p ~/.ssh
          touch ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          if [[ -z "${HOST:-}" ]]; then
            echo "::error:: SSH_HOST secret is empty"; exit 1
          fi

          if [[ -n "${KNOWN:-}" ]]; then
            echo "${KNOWN}" >> ~/.ssh/known_hosts
            echo "Pinned host key from SSH_KNOWN_HOSTS added."
          else
            echo "No SSH_KNOWN_HOSTS provided; fetching via ssh-keyscan."
            # Try to scan; do not fail the job if scan flakes—we'll use accept-new in SSH options
            ssh-keyscan -T 60 ${PORT:+-p "$PORT"} -H "$HOST" >> ~/.ssh/known_hosts 2>/dev/null || \
              echo "::warning:: ssh-keyscan failed; will rely on accept-new for the first connection."
          fi

      - name: Deploy (rsync to subdomain docroot)
        shell: bash
        env:
          HOST:   ${{ secrets.SSH_HOST }}
          USER:   ${{ secrets.SSH_USER }}
          PORT:   ${{ secrets.SSH_PORT }}
          TARGET: ${{ secrets.SSH_TARGET_STAGING }}
        run: |
          set -euo pipefail

          if [[ -z "${HOST:-}" || -z "${USER:-}" || -z "${TARGET:-}" ]]; then
            echo "::error:: One or more deploy secrets are missing (SSH_HOST/SSH_USER/SSH_TARGET_STAGING)"; exit 1
          fi

          OUTDIR="dist/${{ env.QUASAR_MODE }}"
          if [[ ! -d "$OUTDIR" ]]; then
            echo "::error:: Build output '$OUTDIR' not found"; exit 1
          fi

          SSH_OPTS="-p ${PORT:-22} -o ServerAliveInterval=15 -o ServerAliveCountMax=4"
          if [[ ! -s ~/.ssh/known_hosts ]]; then
            # First-time bootstrap: trust the first key we see (trade-off explained in docs)
            SSH_OPTS="$SSH_OPTS -o StrictHostKeyChecking=accept-new"
          else
            SSH_OPTS="$SSH_OPTS -o StrictHostKeyChecking=yes"
          fi

          # Ensure remote dir exists
          ssh $SSH_OPTS "${USER}@${HOST}" "mkdir -p '${TARGET}'"

          # Deploy the build
          rsync -az --delete -e "ssh $SSH_OPTS" "$OUTDIR/" "${USER}@${HOST}:${TARGET}/"

      - name: Smoke test staging (edge-resilient)
        env:
          BASE_URL: https://staging.fundstr.me
        run: |
          set -euo pipefail
          if [[ -x scripts/smoke-tests.sh ]]; then
            scripts/smoke-tests.sh
          else
            # Basic availability check with cache-busting
            curl -I -fsSL "${BASE_URL}/?t=${{ github.run_id }}#${{ github.sha }}" >/dev/null
          fi
