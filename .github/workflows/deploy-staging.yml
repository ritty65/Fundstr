name: Deploy staging (Develop2 â†’ Hostinger)

on:
  push:
    branches: [Develop2]
  workflow_dispatch:

env:
  NODE_VERSION: 20
  BUILD_MODE: spa   # staging: SPA (no service worker). Change to 'pwa' if you want PWA here.

concurrency:
  group: deploy-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: pnpm/action-setup@v4
        with: { run_install: false }

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: '**/pnpm-lock.yaml'

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Use staging env (if present)
        run: if [ -f .env.staging ]; then cp .env.staging .env; fi

      - name: Build app
        run: pnpm quasar build -m ${{ env.BUILD_MODE }}

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download dist
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Detect build dir
        id: detect
        run: |
          set -euo pipefail
          BUILD_DIR="$(find dist -mindepth 1 -maxdepth 1 -type d | head -n 1)"
          test -d "$BUILD_DIR"
          echo "BUILD_DIR=$BUILD_DIR" >> "$GITHUB_OUTPUT"
          echo "Build dir: $BUILD_DIR"
          ls -lah "$BUILD_DIR" | sed -n '1,80p'

      - name: Verify build contents
        run: |
          set -euo pipefail
          DIR="${{ steps.detect.outputs.BUILD_DIR }}"
          test -s "$DIR/index.html" || { echo "::error:: index.html missing in $DIR"; exit 1; }
          if ! find "$DIR" -type f -name "*.js" -print -quit | grep -q .; then
            echo "::error:: no JS bundles found under $DIR"
            find "$DIR" -maxdepth 2 -type f | sed -n '1,200p'
            exit 1
          fi

      - name: Ensure .htaccess + version.txt
        run: |
          DIR="${{ steps.detect.outputs.BUILD_DIR }}"
          cat > "$DIR/.htaccess" <<'HTACCESS'
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
          </IfModule>
          <IfModule mod_headers.c>
            <FilesMatch "^index\.html$">
              Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
              Header set Pragma "no-cache"
              Header set Expires "0"
            </FilesMatch>
            <FilesMatch "\.(js|css|png|jpg|svg|woff2)$">
              Header set Cache-Control "public, max-age=31536000, immutable"
            </FilesMatch>
          </IfModule>
          <IfModule LiteSpeed>
            CacheDisable public /index.html
          </IfModule>
          HTACCESS
          echo "${GITHUB_SHA} $(date -u '+%F %T UTC')" > "$DIR/version.txt"

      - name: Generate known_hosts
        id: kh
        env:
          HOST: ${{ secrets.SSH_HOST }}
          PORT: ${{ secrets.SSH_PORT_STAGING }}
        run: |
          set -euo pipefail
          : "${PORT:=22}"
          ssh-keyscan -p "$PORT" -T 15 "$HOST" 2>/dev/null > kh.txt
          if [ ! -s kh.txt ]; then
            echo "::error:: ssh-keyscan returned nothing for $HOST:$PORT"; exit 1
          fi
          echo "known_hosts<<EOF" >> "$GITHUB_OUTPUT"
          cat kh.txt >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ steps.kh.outputs.known_hosts }}
          if_key_exists: replace

      - name: Prepare target dir
        env:
          HOST:   ${{ secrets.SSH_HOST }}
          USER:   ${{ secrets.SSH_USER_STAGING }}
          TARGET: ${{ secrets.SSH_TARGET_STAGING }}
          PORT:   ${{ secrets.SSH_PORT_STAGING }}
        run: |
          set -euxo pipefail
          case "$TARGET" in
            /home/*/domains/*/public_html/*) ;;
            *) echo "::error:: suspicious TARGET path: $TARGET"; exit 1;;
          esac
          ssh -p "${PORT:-22}" "$USER@$HOST" "T='$TARGET'; mkdir -p \"\$T.__incoming\" \"\$T.__backup\""

      - name: Upload to __incoming (rsync)
        env:
          HOST:   ${{ secrets.SSH_HOST }}
          USER:   ${{ secrets.SSH_USER_STAGING }}
          TARGET: ${{ secrets.SSH_TARGET_STAGING }}
          PORT:   ${{ secrets.SSH_PORT_STAGING }}
        run: |
          set -euxo pipefail
          rsync -az --delete -e "ssh -o StrictHostKeyChecking=yes -p ${PORT:-22}" \
            "${{ steps.detect.outputs.BUILD_DIR }}/" \
            "$USER@$HOST:$TARGET.__incoming/"

      - name: Atomic swap
        env:
          HOST:   ${{ secrets.SSH_HOST }}
          USER:   ${{ secrets.SSH_USER_STAGING }}
          TARGET: ${{ secrets.SSH_TARGET_STAGING }}
          PORT:   ${{ secrets.SSH_PORT_STAGING }}
        run: |
          set -euxo pipefail
          ssh -p "${PORT:-22}" "$USER@$HOST" "
            set -e
            T='$TARGET'
            if [ -d \"\$T\" ]; then
              rm -rf \"\$T.__backup/prev\" || true
              mv \"\$T\" \"\$T.__backup/prev\"
            fi
            test -d \"\$T.__incoming\" || { echo 'ERROR: missing '\"\$T.__incoming\"; exit 1; }
            mv \"\$T.__incoming\" \"\$T\"
            ls -lah \"\$T\" | sed -n '1,40p'
          "

      - name: Smoke check
        run: |
          set -euo pipefail
          curl -fsSI https://staging.fundstr.me/ | sed -n '1,20p'
          curl -fsSI https://staging.fundstr.me/find-creators | sed -n '1,20p'
          curl -fsS  https://staging.fundstr.me/version.txt | tee /tmp/version.txt
          curl -fsS  https://staging.fundstr.me/ | grep -i -E "Fundstr|Nostr User Search"

      - name: Verify main module bundle is reachable
        run: |
          set -euo pipefail
          HTML="$(curl -fsS https://staging.fundstr.me/)"
          SRC="$(printf '%s\n' "$HTML" \
            | sed -nE 's/.*<script[^>]*type="module"[^>]*src="([^"]+)".*/\1/p' \
            | head -n 1)"
          if [ -z "$SRC" ]; then
            echo "::error:: could not locate <script type=\"module\"> in staging index.html"
            printf '%s\n' "$HTML" | sed -n '1,120p'
            exit 1
          fi
          case "$SRC" in
            http://*|https://*)
              URL="$SRC"
              ;;
            /*)
              URL="https://staging.fundstr.me$SRC"
              ;;
            *)
              URL="https://staging.fundstr.me/$SRC"
              ;;
          esac
          curl -sSI "$URL" -o /tmp/module_headers
          STATUS="$(awk 'toupper($1) ~ /^HTTP\// {print $2; exit}' /tmp/module_headers)"
          if [ "${STATUS:-}" != "200" ]; then
            echo "::error:: expected HTTP 200 for $URL, got ${STATUS:-unknown}"
            cat /tmp/module_headers
            exit 1
          fi
          if ! grep -qi '^content-type:.*javascript' /tmp/module_headers; then
            echo "::error:: $URL missing javascript content-type"
            cat /tmp/module_headers
            exit 1
          fi
          cat /tmp/module_headers
