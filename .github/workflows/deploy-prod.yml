name: Deploy production (main â†’ Hostinger)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  checks: read
  statuses: read

concurrency:
  group: deploy-production-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://fundstr.me
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate predeploy quality gate
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          PREDEPLOY_REQUIRED_CHECKS: Test,build
          PREDEPLOY_TIMEOUT_MS: 1200000
          PREDEPLOY_POLL_INTERVAL_MS: 15000
        run: node scripts/ci/predeploy-gate.mjs

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          corepack prepare pnpm@8.15.7 --activate
          pnpm --version

      - name: Validate production deploy target
        run: |
          if [ -z "${{ secrets.SSH_TARGET_PRODUCTION }}" ]; then
            echo "::error::Missing required secret SSH_TARGET_PRODUCTION"
            exit 1
          fi

      - name: Use production env
        run: cp .env.production .env

      - name: Install deps
        run: |
          set -euo pipefail
          for attempt in 1 2 3; do
            if pnpm install --frozen-lockfile=false; then
              exit 0
            fi
            if [ "$attempt" -eq 3 ]; then
              echo "::error:: pnpm install failed after 3 attempts"
              exit 1
            fi
            echo "pnpm install failed (attempt $attempt). Retrying..."
            sleep $((attempt * 5))
          done

      - name: Build (Quasar PWA)
        run: pnpm run build

      - name: Verify deploy artifacts
        run: node scripts/ci/verify-deploy-artifacts.mjs

      - name: Write deploy marker
        run: |
          BUILD_TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "env=production"
            echo "sha=${{ github.sha }}"
            echo "ref=${{ github.ref_name }}"
            echo "built_at=$BUILD_TS"
            echo "run_id=${{ github.run_id }}"
          } > dist/pwa/deploy.txt

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Trust remote host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Validate deploy target
        id: target
        env:
          TARGET_RAW: ${{ secrets.SSH_TARGET_PRODUCTION }}
        run: |
          set -euo pipefail
          TARGET="${TARGET_RAW%/}"
          test -n "$TARGET" || {
            echo "::error:: SSH_TARGET_PRODUCTION is empty"
            exit 1
          }
          case "$TARGET" in
            /home/*/domains/*/public_html|/home/*/domains/*/public_html/*) ;;
            *)
              echo "::error:: suspicious SSH_TARGET_PRODUCTION path: $TARGET"
              exit 1
              ;;
          esac
          echo "target=$TARGET" >> "$GITHUB_OUTPUT"

      - name: Prepare target dir
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          TARGET: ${{ steps.target.outputs.target }}
          PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euxo pipefail
          ssh -p "${PORT:-22}" "$USER@$HOST" "T='$TARGET'; mkdir -p \"\$T.__incoming\" \"\$T.__backup\""

      - name: Upload to __incoming (rsync)
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          TARGET: ${{ steps.target.outputs.target }}
          PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euxo pipefail
          rsync -az --delete \
            -e "ssh -o StrictHostKeyChecking=yes -p ${PORT:-22}" \
            dist/pwa/ \
            "$USER@$HOST:$TARGET.__incoming/"

      - name: Atomic swap
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          TARGET: ${{ steps.target.outputs.target }}
          PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euxo pipefail
          ssh -p "${PORT:-22}" "$USER@$HOST" "
            set -e
            T='$TARGET'
            if [ -d \"\$T\" ]; then
              rm -rf \"\$T.__backup/prev\" || true
              mv \"\$T\" \"\$T.__backup/prev\"
            fi
            test -d \"\$T.__incoming\" || { echo 'ERROR: missing '\"\$T.__incoming\"; exit 1; }
            mv \"\$T.__incoming\" \"\$T\"
            ls -lah \"\$T\" | sed -n '1,40p'
          "

      - name: Verify remote deploy artifacts
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          TARGET: ${{ steps.target.outputs.target }}
          PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euo pipefail
          ssh -p "${PORT:-22}" "$USER@$HOST" "set -e; test -f \"$TARGET/index.html\"; test -f \"$TARGET/find-creators.html\"; test -f \"$TARGET/featured-creators.json\"; test -f \"$TARGET/manifest.json\"; test -f \"$TARGET/vendor/nostr.bundle.1.17.0.js\"; test -f \"$TARGET/deploy.txt\""

      - name: Smoke test production
        env:
          BASE_URL: ${{ vars.PRODUCTION_BASE_URL }}
        run: |
          if [ -z "$BASE_URL" ]; then
            BASE_URL="https://fundstr.me"
          fi
          BASE_URL="$BASE_URL" ./scripts/smoke-tests.sh
