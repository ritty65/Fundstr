name: Deploy production (main â†’ Hostinger)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  checks: read
  statuses: read

concurrency:
  group: deploy-production-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://fundstr.me
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate predeploy quality gate
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
          PREDEPLOY_REQUIRED_CHECKS: Test,build
          PREDEPLOY_TIMEOUT_MS: 1200000
          PREDEPLOY_POLL_INTERVAL_MS: 15000
        run: node scripts/ci/predeploy-gate.mjs

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          corepack prepare pnpm@8.15.7 --activate
          pnpm --version

      - name: Validate production deploy target
        run: |
          if [ -z "${{ secrets.SSH_TARGET_PRODUCTION }}" ]; then
            echo "::error::Missing required secret SSH_TARGET_PRODUCTION"
            exit 1
          fi

      - name: Use production env
        run: cp .env.production .env

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Build (Quasar PWA)
        run: pnpm run build

      - name: Verify deploy artifacts
        run: node scripts/ci/verify-deploy-artifacts.mjs

      - name: Write deploy marker
        run: |
          BUILD_TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "env=production"
            echo "sha=${{ github.sha }}"
            echo "ref=${{ github.ref_name }}"
            echo "built_at=$BUILD_TS"
            echo "run_id=${{ github.run_id }}"
          } > dist/pwa/deploy.txt

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Trust remote host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy (rsync)
        run: |
          rsync -avz --delete \
            -e "ssh -p ${{ secrets.SSH_PORT }}" \
            dist/pwa/ \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_TARGET_PRODUCTION }}/"

      - name: Verify remote deploy artifacts
        run: |
          ssh -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "set -e; test -f \"${{ secrets.SSH_TARGET_PRODUCTION }}/index.html\"; test -f \"${{ secrets.SSH_TARGET_PRODUCTION }}/find-creators.html\"; test -f \"${{ secrets.SSH_TARGET_PRODUCTION }}/featured-creators.json\"; test -f \"${{ secrets.SSH_TARGET_PRODUCTION }}/manifest.json\"; test -f \"${{ secrets.SSH_TARGET_PRODUCTION }}/vendor/nostr.bundle.1.17.0.js\"; test -f \"${{ secrets.SSH_TARGET_PRODUCTION }}/deploy.txt\""

      - name: Smoke test production
        env:
          BASE_URL: ${{ vars.PRODUCTION_BASE_URL }}
        run: |
          if [ -z "$BASE_URL" ]; then
            BASE_URL="https://fundstr.me"
          fi
          BASE_URL="$BASE_URL" ./scripts/smoke-tests.sh
