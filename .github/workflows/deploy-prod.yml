name: Deploy production (main â†’ Hostinger)

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch to deploy (must be main)"
        required: true
        default: "main"

concurrency:
  group: deploy-production-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    # Guard: only allow main (push or manual)
    if: >
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.ref == 'main')

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable pnpm via Corepack
        run: |
          corepack enable
          corepack prepare pnpm@8.15.7 --activate
          pnpm --version

      - name: Install rsync + ssh-client
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: Set build id
        run: echo "VITE_BUILD_ID=${GITHUB_SHA::7}-${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      - name: Install deps
        run: pnpm install --frozen-lockfile=false

      - name: Build (Quasar PWA)
        run: pnpm quasar build -m pwa

      - name: Verify deploy artifacts
        env:
          DEPLOY_DIST_DIR: dist/pwa
          EXPECT_SW: "1"
        run: pnpm run verify:deploy-artifacts

      - name: Enforce .htaccess with cache headers (in built bundle)
        run: |
          cat > dist/pwa/.htaccess <<'EOF'
          <IfModule mod_rewrite.c>
            Options -MultiViews
            RewriteEngine On
            RewriteRule ^assets/ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^ index.html [QSA,L]
          </IfModule>

          <IfModule mod_headers.c>
            Header always set Vary "Accept-Encoding"

            <Files "sw.js">
              Header always unset Cache-Control
              Header always unset Expires
              Header always unset Pragma
              Header always set Cache-Control "no-cache, no-store, must-revalidate"
              Header always set Pragma "no-cache"
              Header always set Expires "0"
            </Files>

            <FilesMatch "^workbox-.*\.js$">
              Header always unset Cache-Control
              Header always set Cache-Control "no-cache, no-store, must-revalidate"
            </FilesMatch>

            <Files "manifest.json">
              Header always unset Cache-Control
              Header always set Cache-Control "no-cache, no-store, must-revalidate"
            </Files>

            <FilesMatch "\.(html)$">
              Header always set Cache-Control "no-cache, no-store, must-revalidate"
              Header always set Pragma "no-cache"
              Header always set Expires "0"
            </FilesMatch>

            <FilesMatch "^(?!sw\.js$|workbox-.*\.js$).*\.(js|mjs|css|png|jpe?g|svg|gif|webp|ico|woff2?|ttf|map)$">
              Header always set Cache-Control "public, max-age=31536000, immutable, no-transform"
            </FilesMatch>
          </IfModule>

          <IfModule mod_mime.c>
            AddType application/javascript .js .mjs
            AddType application/wasm .wasm
          </IfModule>
          EOF

      - name: Write deploy marker
        run: |
          BUILD_TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          {
            echo "env=production"
            echo "sha=${GITHUB_SHA}"
            echo "ref=${GITHUB_REF_NAME}"
            echo "built_at=$BUILD_TS"
            echo "run_id=${GITHUB_RUN_ID}"
          } > dist/pwa/deploy.txt

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Trust remote host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Validate deploy target
        env:
          TARGET: ${{ secrets.SSH_TARGET_PROD }}
        run: |
          set -euo pipefail
          test -n "$TARGET" || {
            echo "::error:: SSH_TARGET_PROD is empty"
            exit 1
          }
          case "$TARGET" in
            /home/*/domains/*/public_html|/home/*/domains/*/public_html/*) ;;
            *)
              echo "::error:: suspicious SSH_TARGET_PROD path: $TARGET"
              exit 1
              ;;
          esac

      - name: Prepare target dir
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          TARGET: ${{ secrets.SSH_TARGET_PROD }}
          PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euxo pipefail
          ssh -p "${PORT:-22}" "$USER@$HOST" "T='$TARGET'; mkdir -p \"\$T.__incoming\" \"\$T.__backup\""

      - name: Upload to __incoming (rsync)
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          TARGET: ${{ secrets.SSH_TARGET_PROD }}
          PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euxo pipefail
          rsync -az --delete \
            -e "ssh -o StrictHostKeyChecking=yes -p ${PORT:-22}" \
            dist/pwa/ \
            "$USER@$HOST:$TARGET.__incoming/"

      - name: Atomic swap
        env:
          HOST: ${{ secrets.SSH_HOST }}
          USER: ${{ secrets.SSH_USER }}
          TARGET: ${{ secrets.SSH_TARGET_PROD }}
          PORT: ${{ secrets.SSH_PORT }}
        run: |
          set -euxo pipefail
          ssh -p "${PORT:-22}" "$USER@$HOST" "
            set -e
            T='$TARGET'
            if [ -d \"\$T\" ]; then
              rm -rf \"\$T.__backup/prev\" || true
              mv \"\$T\" \"\$T.__backup/prev\"
            fi
            test -d \"\$T.__incoming\" || { echo 'ERROR: missing '\"\$T.__incoming\"; exit 1; }
            mv \"\$T.__incoming\" \"\$T\"
            ls -lah \"\$T\" | sed -n '1,40p'
          "

      - name: Smoke test production
        env:
          BASE_URL: https://fundstr.me
          EXPECT_SW: "1"
          DISCOVERY_ROUTE: /find-creators
          DEPLOY_MARKER_REQUIRED: "1"
        run: ./scripts/smoke-tests.sh
