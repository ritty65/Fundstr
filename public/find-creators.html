<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nostr User Search & Featured Creators</title>
    <link rel="preload" as="style" href="find-creators.css" />
    <link rel="stylesheet" href="find-creators.css" />
    <!-- nostr-tools CDN -->
    <script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7fafc; /* Tailwind gray-100 */
        color: #2d3748; /* Tailwind gray-800 */
      }
      .container {
        width: 100%;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: clamp(2rem, 4vw, 3rem);
        padding: clamp(1.5rem, 4vw, 3rem) clamp(1rem, 4vw, 2.5rem);
        box-sizing: border-box;
      }
      .search-container,
      .featured-creators-container {
        width: min(100%, clamp(320px, 85vw, 1100px));
        margin: 0 auto;
        padding: clamp(1.5rem, 4vw, 2.5rem);
        background-color: white;
        border-radius: 0.75rem; /* Tailwind rounded-xl */
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Tailwind shadow-lg */
      }
      .search-input {
        width: 100%;
        padding: 0.875rem 1.25rem; /* Increased padding */
        border: 1px solid #e2e8f0; /* Tailwind gray-300 */
        border-radius: 0.5rem; /* Tailwind rounded-lg */
        font-size: 1rem;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        color: #2d3748; /* Tailwind gray-800 */
      }
      .search-input:focus {
        outline: none;
        border-color: #4299e1; /* Tailwind blue-500 */
        box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* Tailwind ring-blue-500 ring-opacity-50 */
      }
      .results-list,
      .featured-creators-grid {
        margin-top: 1.5rem;
        list-style: none;
        padding: 0;
      }
      .featured-creators-grid {
        display: grid;
        grid-template-columns: repeat(
          auto-fill,
          minmax(280px, 1fr)
        ); /* Responsive grid */
        gap: 1.5rem;
      }
      .result-item,
      .creator-card {
        padding: 1.25rem;
        border: 1px solid #e2e8f0; /* Tailwind gray-300 */
        border-radius: 0.75rem; /* Tailwind rounded-xl */
        margin-bottom: 1rem;
        background-color: #fdfdff; /* Slightly off-white */
        transition: all 0.2s ease-in-out;
        display: flex;
        flex-direction: column; /* Ensure actions container is below info */
        gap: 0.5rem; /* Reduced gap for tighter layout within card */
      }
      .creator-card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07),
          0 2px 4px -1px rgba(0, 0, 0, 0.04);
        position: relative;
      }
      .result-item {
        position: relative;
      }
      .result-item:hover,
      .creator-card:hover {
        background-color: #f0f5ff; /* Lighter blue hover */
        border-color: #bee3f8; /* Tailwind blue-200 */
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      .profile-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        width: 100%;
      }
      .profile-header img.avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e2e8f0; /* Tailwind gray-300 */
        flex-shrink: 0;
      }
      .profile-header .info {
        flex-grow: 1;
        min-width: 0;
      }
      .profile-header .info h3 {
        font-size: 1.125rem; /* Tailwind text-lg */
        font-weight: 600; /* Tailwind font-semibold */
        color: #2d3748; /* Tailwind gray-800 */
        word-break: break-word;
        margin-bottom: 0.25rem;
      }
      .profile-header .info p {
        font-size: 0.875rem; /* Tailwind text-sm */
        color: #4a5568; /* Tailwind gray-700 */
        margin-top: 0.1rem;
        word-break: break-word;
        line-height: 1.4;
      }
      .profile-header .info .nip05 {
        font-weight: 500;
        color: #3182ce; /* Tailwind blue-600 */
      }
      .creator-actions {
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        padding-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
        width: 100%;
        justify-content: flex-start;
      }
      .creator-card:hover .creator-actions,
      .result-item:hover .creator-actions {
        opacity: 1;
      }
      .action-button {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.375rem;
        color: white;
        transition: background-color 0.2s;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }
      .view-button {
        background-color: #a0aec0;
      }
      .view-button:hover {
        background-color: #718096;
      }
      .message-button {
        background-color: #4299e1;
      }
      .message-button:hover {
        background-color: #3182ce;
      }
      .donate-button {
        background-color: #48bb78;
      }
      .donate-button:hover {
        background-color: #38a169;
      }
      .status-message {
        text-align: center;
        color: #718096;
        padding: 1.5rem;
        font-style: italic;
      }
      .relay-warning {
        margin-top: 1rem;
        padding: 0.75rem 1rem;
        background-color: #fef3c7;
        border: 1px solid #f6ad55;
        border-radius: 0.5rem;
        color: #b7791f;
        font-weight: 600;
      }
      .retry-button {
        margin: 0 auto;
        margin-top: -1rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: white;
        background-color: #4299e1;
        border-radius: 0.375rem;
        transition: background-color 0.2s;
        display: block;
      }
      .retry-button:hover {
        background-color: #3182ce;
      }
      .loader {
        display: none;
        margin: 1.5rem auto;
        border: 4px solid #e2e8f0;
        border-top: 4px solid #4299e1;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .relay-info {
        font-size: 0.8rem;
        color: #718096;
        text-align: center;
        margin-top: 1.5rem;
        padding: 0.75rem;
        background-color: #edf2f7;
        border-radius: 0.5rem;
      }
      .copy-button {
        background-color: #edf2f7;
        color: #4a5568;
        padding: 0.25rem 0.6rem;
        font-size: 0.75rem;
        border-radius: 0.375rem;
        cursor: pointer;
        margin-left: 0.5rem;
        border: 1px solid #cbd5e0;
        transition: background-color 0.2s;
      }
      .copy-button:hover {
        background-color: #e2e8f0;
      }
      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 1.5rem;
        text-align: center;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e2e8f0;
      }
      body.dark .section-title {
        color: #e2e8f0;
        border-bottom-color: #4a5568;
      }
      body.dark {
        background-color: #1a202c;
        color: #e2e8f0;
      }
      body.dark .search-container,
      body.dark .featured-creators-container {
        background-color: #2d3748;
        color: #e2e8f0;
      }
      body.dark .search-input {
        background-color: #2d3748;
        border-color: #4a5568;
        color: #e2e8f0;
      }
      body.dark .result-item,
      body.dark .creator-card {
        background-color: #2d3748;
        border-color: #4a5568;
      }
      body.dark .result-item:hover,
      body.dark .creator-card:hover {
        background-color: #4a5568;
        border-color: #718096;
      }
      body.dark .profile-header .info h3 {
        color: #e2e8f0;
      }
      body.dark .profile-header .info p {
        color: #a0aec0;
      }
      body.dark .profile-header .info .nip05 {
        color: #63b3ed;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container">
      <div class="search-container">
        <h1 class="section-title">Nostr User Search</h1>
        <p class="text-sm text-center text-gray-600 mb-6">
          Search by name, npub, or NIP-05 identifier (e.g., user@domain.com).
        </p>
        <input
          type="text"
          id="searchInput"
          class="search-input"
          placeholder="Search Nostr profiles..."
        />
        <div id="loader" class="loader"></div>
        <ul id="resultsList" class="results-list"></ul>
        <p id="statusMessage" class="status-message hidden"></p>
        <button id="retryButton" class="retry-button hidden" type="button">
          Retry
        </button>
      </div>

      <div class="featured-creators-container">
        <h2 class="section-title">Featured Creators</h2>
        <div
          id="featuredCreatorsLoader"
          class="loader"
          style="display: block"
        ></div>
        <div id="featuredCreatorsGrid" class="featured-creators-grid"></div>
        <p id="featuredStatusMessage" class="status-message hidden"></p>
      </div>

      <p id="relayWarning" class="relay-warning hidden" hidden></p>
    </div>

    <script type="module" defer>
      const DISCOVERY_ENDPOINT = "https://relay.fundstr.me/discover/creators";

      const statusMessageElement = document.getElementById("statusMessage");
      const retryButtonElement = document.getElementById("retryButton");
      const loaderElement = document.getElementById("loader");
      const searchInputElement = document.getElementById("searchInput");
      const resultsListElement = document.getElementById("resultsList");
      const featuredCreatorsGridElement = document.getElementById(
        "featuredCreatorsGrid",
      );
      const featuredCreatorsLoaderElement = document.getElementById(
        "featuredCreatorsLoader",
      );
      const featuredStatusMessageElement = document.getElementById(
        "featuredStatusMessage",
      );

      const nostrTools = window.NostrTools;
      const nip19 = nostrTools?.nip19;
      if (!nip19) {
        statusMessageElement.textContent =
          "Error: nostr-tools library not loaded.";
        statusMessageElement.classList.remove("hidden");
      }

      document.body.classList.toggle(
        "dark",
        window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches,
      );

      const FEATURED_NPUBS = [
        "npub1aljmhjp5tqrw3m60ra7t3u8uqq223d6rdg9q0h76a8djd9m4hmvsmlj82m",
        "npub1sg6plzptd64u62a878hep2kev88swjh3tw00gjsfl8f237lmu63q0uf63m",
        "npub1qny3tkh0acurzla8x3zy4nhrjz5zd8l9sy9jys09umwng00manysew95gx",
        "npub1cj8znuztfqkvq89pl8hceph0svvvqk0qay6nydgk9uyq7fhpfsgsqwrz4u",
        "npub1a2cww4kn9wqte4ry70vyfwqyqvpswksna27rtxd8vty6c74era8sdcw83a",
        "npub1s05p3ha7en49dv8429tkk07nnfa9pcwczkf5x5qrdraqshxdje9sq6eyhe",
        "npub180cvv07tjdrrgpa0j7j7tmnyl2yr6yr7l8j4s3evf6u64th6gkwsyjh6w6",
        "npub1dergggklka99wwrs92yz8wdjs952h2ux2ha2ed598ngwu9w7a6fsh9xzpc",
        "npub1s5yq6wadwrxde4lhfs56gn64hwzuhnfa6r9mj476r5s4hkunzgzqrs6q7z",
        "npub1spdnfacgsd7lk0nlqkq443tkq4jx9z6c6ksvaquuewmw7d3qltpslcq6j7",
      ];

      const nip05Regex = /^([a-zA-Z0-9_.-]+)@([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})$/;

      let currentSearchAbortController = null;
      let lastSearchQuery = "";

      function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
      }

      function fetchWithTimeout(resource, options = {}) {
        const { timeout = 8000 } = options;
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        const promise = fetch(resource, {
          ...options,
          signal: controller.signal,
        });
        promise.finally(() => clearTimeout(id));
        return promise;
      }

      function initializeSearchState() {
        resultsListElement.textContent = "";
        statusMessageElement.textContent = "";
        statusMessageElement.classList.add("hidden");
        retryButtonElement.classList.add("hidden");
      }

      function updateStatus(message, hide = false, showRetry = false) {
        if (hide) {
          statusMessageElement.classList.add("hidden");
        } else {
          statusMessageElement.textContent = message;
          statusMessageElement.classList.remove("hidden");
        }

        if (showRetry) {
          retryButtonElement.classList.remove("hidden");
        } else {
          retryButtonElement.classList.add("hidden");
        }
      }

      function safeString(...values) {
        for (const value of values) {
          if (typeof value === "string" && value.trim()) {
            return value.trim();
          }
        }
        return "";
      }

      function buildProfilesFromResults(results) {
        if (!Array.isArray(results)) return [];
        return results
          .map((entry) => {
            if (!entry || typeof entry !== "object") return null;
            const meta =
              entry.meta && typeof entry.meta === "object" ? entry.meta : {};
            const profile =
              entry.profile && typeof entry.profile === "object"
                ? entry.profile
                : {};

            const pubkey = safeString(entry.pubkey);
            if (!pubkey) return null;

            return {
              pubkey,
              name: safeString(
                profile.display_name,
                meta.display_name,
                profile.name,
                meta.name,
                profile.username,
                meta.username,
              ),
              nip05: safeString(profile.nip05, meta.nip05),
              picture: safeString(profile.picture, meta.picture),
              about: safeString(profile.about, meta.about),
              lud16: safeString(profile.lud16, meta.lud16, profile.lud06, meta.lud06),
            };
          })
          .filter((profile) => profile !== null);
      }

      async function fetchCreatorsFromDiscovery(query, signal) {
        const url = `${DISCOVERY_ENDPOINT}?q=${encodeURIComponent(query)}`;
        const response = await fetchWithTimeout(url, { signal });
        if (!response.ok) {
          const error = new Error(`HTTP ${response.status}`);
          error.isHttpError = true;
          throw error;
        }
        let data;
        try {
          data = await response.json();
        } catch (parseError) {
          const error = new Error("Invalid response from discovery service");
          error.cause = parseError;
          throw error;
        }
        return Array.isArray(data?.results) ? data.results : [];
      }

      function handleDiscoveryError(error, contextMessage) {
        if (error?.name === "AbortError") {
          return;
        }
        console.error(contextMessage, error);
        const message =
          error?.isHttpError ||
          (typeof error?.message === "string" &&
            error.message.includes("Failed to fetch"))
            ? "Network error: could not reach discovery service."
            : `${contextMessage}: ${error?.message || "Unknown error"}`;
        const showRetry = true;
        updateStatus(message, false, showRetry);
      }

      function formatNpub(pubkey) {
        if (!pubkey) return "";
        if (nip19?.npubEncode) {
          try {
            return nip19.npubEncode(pubkey);
          } catch (error) {
            console.warn("Failed to encode pubkey to npub", error);
          }
        }
        return pubkey;
      }

      async function handleSearch(query) {
        const cleanQuery = query.trim();
        lastSearchQuery = cleanQuery;

        if (currentSearchAbortController) {
          currentSearchAbortController.abort();
        }
        if (!cleanQuery) {
          initializeSearchState();
          loaderElement.style.display = "none";
          return;
        }

        currentSearchAbortController = new AbortController();
        const { signal } = currentSearchAbortController;

        initializeSearchState();
        loaderElement.style.display = "block";
        updateStatus("Searching Fundstr discovery service...");

        try {
          if (nip05Regex.test(cleanQuery)) {
            updateStatus("Resolving NIP-05 identifier...");
            const resolved = await resolveNip05(cleanQuery, signal);
            if (signal.aborted) return;
            if (resolved?.pubkey) {
              await findProfileByPubkey(resolved.pubkey, signal);
            } else {
              updateStatus("Could not resolve NIP-05 identifier.");
            }
            return;
          }

          if (cleanQuery.startsWith("npub1") || cleanQuery.startsWith("nprofile1")) {
            await findProfileByPubkey(cleanQuery, signal);
            return;
          }

          if (
            cleanQuery.length === 64 &&
            /^[0-9a-fA-F]+$/.test(cleanQuery)
          ) {
            await findProfileByPubkey(cleanQuery.toLowerCase(), signal);
            return;
          }

          const results = await fetchCreatorsFromDiscovery(cleanQuery, signal);
          if (signal.aborted) return;
          const profiles = buildProfilesFromResults(results);
          renderProfiles(profiles, resultsListElement, false);
          loaderElement.style.display = "none";
          if (profiles.length > 0) {
            updateStatus("", true);
          } else {
            updateStatus("No profiles found matching your search.");
          }
        } catch (error) {
          handleDiscoveryError(error, "Search failed");
        } finally {
          if (!signal.aborted) {
            loaderElement.style.display = "none";
          }
        }
      }

      async function findProfileByPubkey(pubkey, signal) {
        initializeSearchState();
        loaderElement.style.display = "block";
        updateStatus("Looking up creator profile...");

        try {
          const results = await fetchCreatorsFromDiscovery(pubkey, signal);
          if (signal.aborted) return;
          const profiles = buildProfilesFromResults(results);
          renderProfiles(profiles, resultsListElement, false);
          loaderElement.style.display = "none";
          if (profiles.length > 0) {
            updateStatus("", true);
            window.parent.postMessage({ type: "viewProfile", pubkey }, "*");
          } else {
            updateStatus("Profile not found.");
          }
        } catch (error) {
          handleDiscoveryError(error, "Profile lookup failed");
        } finally {
          if (!signal.aborted) {
            loaderElement.style.display = "none";
          }
        }
      }

      async function resolveNip05(identifier, signal) {
        const match = identifier.match(nip05Regex);
        if (!match) return null;
        const [, localPart, domain] = match;
        const wellKnownUrl = `https://${domain}/.well-known/nostr.json?name=${encodeURIComponent(
          localPart,
        )}`;
        try {
          const response = await fetchWithTimeout(wellKnownUrl, { signal });
          if (!response.ok) return null;
          const data = await response.json();
          if (data?.names && typeof data.names === "object") {
            const entry = data.names[localPart];
            if (typeof entry === "string" && entry.trim()) {
              return { pubkey: entry.trim() };
            }
          }
        } catch (error) {
          if (error?.name !== "AbortError") {
            console.warn("NIP-05 resolution failed", error);
          }
        }
        return null;
      }

      function renderProfiles(profiles, targetElement, isFeatured) {
        targetElement.textContent = "";
        if (!Array.isArray(profiles) || profiles.length === 0) {
          return;
        }

        const sorted = [...profiles].sort((a, b) => {
          const nameA = (a?.name ?? "").toLowerCase();
          const nameB = (b?.name ?? "").toLowerCase();
          return nameA.localeCompare(nameB);
        });

        sorted.forEach((profile) => {
          if (!profile || !profile.pubkey) return;

          const cardElement = document.createElement(isFeatured ? "div" : "li");
          cardElement.className = `${
            isFeatured ? "creator-card" : "result-item"
          } group`;

          const header = document.createElement("div");
          header.className = "profile-header";

          const avatarImg = document.createElement("img");
          avatarImg.className = "avatar";
          const fallbackLetter = (profile.name || profile.nip05 || "N")[0]
            ?.toUpperCase?.() ?? "N";
          const avatarSrc = isTrustedUrl(profile.picture)
            ? profile.picture
            : `https://placehold.co/50x50/A0AEC0/FFFFFF?text=${fallbackLetter}`;
          avatarImg.src = avatarSrc;
          avatarImg.alt = profile.name || profile.nip05 || "Nostr user";
          avatarImg.onerror = function () {
            this.onerror = null;
            this.src = `https://placehold.co/50x50/A0AEC0/FFFFFF?text=${fallbackLetter}`;
          };

          const infoDiv = document.createElement("div");
          infoDiv.className = "info";

          const nameElement = document.createElement("h3");
          nameElement.textContent =
            profile.name ||
            (profile.nip05 ? profile.nip05.split("@")[0] : "Unnamed User");
          infoDiv.appendChild(nameElement);

          const npub = formatNpub(profile.pubkey);
          if (npub) {
            const npubElement = document.createElement("p");
            const npubStrong = document.createElement("strong");
            npubStrong.textContent = "Npub:";
            npubElement.appendChild(npubStrong);
            const short = `${npub.substring(0, 10)}...${npub.substring(
              npub.length - 5,
            )}`;
            npubElement.append(` ${short}`);
            npubElement.title = npub;

            const copyButton = document.createElement("button");
            copyButton.type = "button";
            copyButton.textContent = "Copy";
            copyButton.className = "copy-button";
            copyButton.addEventListener("click", (event) => {
              event.stopPropagation();
              copyToClipboard(npub, copyButton);
            });
            npubElement.appendChild(copyButton);

            infoDiv.appendChild(npubElement);
          }

          if (profile.nip05) {
            const nip05Element = document.createElement("p");
            const nip05Strong = document.createElement("strong");
            nip05Strong.textContent = "NIP-05:";
            nip05Element.appendChild(nip05Strong);
            const span = document.createElement("span");
            span.className = "nip05";
            span.textContent = profile.nip05;
            nip05Element.append(" ");
            nip05Element.appendChild(span);
            infoDiv.appendChild(nip05Element);
          }

          if (profile.about) {
            const aboutElement = document.createElement("p");
            const maxLength = isFeatured ? 80 : 150;
            const shortened =
              profile.about.length > maxLength
                ? `${profile.about.slice(0, maxLength)}...`
                : profile.about;
            const aboutEm = document.createElement("em");
            aboutEm.textContent = shortened;
            aboutElement.appendChild(aboutEm);
            aboutElement.title = profile.about;
            infoDiv.appendChild(aboutElement);
          }

          if (profile.lud16) {
            const lud16Element = document.createElement("p");
            const lud16Strong = document.createElement("strong");
            lud16Strong.textContent = "LN:";
            lud16Element.appendChild(lud16Strong);
            lud16Element.append(` ${profile.lud16}`);
            infoDiv.appendChild(lud16Element);
          }

          header.appendChild(avatarImg);
          header.appendChild(infoDiv);
          cardElement.appendChild(header);

          const actionsContainer = document.createElement("div");
          actionsContainer.className = "creator-actions";

          const viewButton = document.createElement("button");
          viewButton.type = "button";
          viewButton.className = "action-button view-button";
          viewButton.textContent = "View Subscription Tiers";
          viewButton.addEventListener("click", (event) => {
            event.stopPropagation();
            window.parent.postMessage(
              { type: "viewProfile", pubkey: profile.pubkey },
              "*",
            );
          });

          const messageButton = document.createElement("button");
          messageButton.type = "button";
          messageButton.className = "action-button message-button";
          messageButton.textContent = "Message";
          messageButton.addEventListener("click", (event) => {
            event.stopPropagation();
            window.parent.postMessage(
              { type: "startChat", pubkey: profile.pubkey },
              "*",
            );
          });

          const donateButton = document.createElement("button");
          donateButton.type = "button";
          donateButton.className = "action-button donate-button";
          donateButton.textContent = "Donate";
          donateButton.addEventListener("click", (event) => {
            event.stopPropagation();
            window.parent.postMessage(
              { type: "donate", pubkey: profile.pubkey },
              "*",
            );
          });

          actionsContainer.appendChild(viewButton);
          actionsContainer.appendChild(messageButton);
          actionsContainer.appendChild(donateButton);
          cardElement.appendChild(actionsContainer);

          targetElement.appendChild(cardElement);
        });
      }

      function isTrustedUrl(url) {
        try {
          const parsed = new URL(url, window.location.origin);
          return parsed.protocol === "http:" || parsed.protocol === "https:";
        } catch (error) {
          return false;
        }
      }

      function copyToClipboard(text, buttonElement) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand("copy");
          if (buttonElement) {
            const original = buttonElement.textContent;
            buttonElement.textContent = "Copied!";
            setTimeout(() => {
              buttonElement.textContent = original;
            }, 2000);
          }
        } catch (error) {
          console.error("Failed to copy text", error);
        }
        document.body.removeChild(textArea);
      }

      async function init() {
        featuredStatusMessageElement.textContent = "Loading featured creators...";
        featuredStatusMessageElement.classList.remove("hidden");

        const CACHE_KEY = "featured.creators:v1";
        const CACHE_TTL = 24 * 60 * 60 * 1000;
        let profiles = null;

        try {
          const cached = localStorage.getItem(CACHE_KEY);
          if (cached) {
            const parsed = JSON.parse(cached);
            if (
              parsed?.timestamp &&
              Array.isArray(parsed?.profiles) &&
              Date.now() - parsed.timestamp < CACHE_TTL
            ) {
              profiles = parsed.profiles;
            }
          }
        } catch (error) {
          console.warn("Failed to read featured creators cache", error);
        }

        if (!profiles) {
          try {
            featuredCreatorsLoaderElement.style.display = "block";
            const response = await fetch("featured-creators.json");
            if (response.ok) {
              profiles = await response.json();
              localStorage.setItem(
                CACHE_KEY,
                JSON.stringify({ timestamp: Date.now(), profiles }),
              );
            }
          } catch (error) {
            console.warn("Failed to load featured creators JSON", error);
          }
        }

        featuredCreatorsLoaderElement.style.display = "none";

        if (profiles && profiles.length) {
          renderProfiles(profiles, featuredCreatorsGridElement, true);
          featuredStatusMessageElement.classList.add("hidden");
        } else {
          featuredStatusMessageElement.textContent =
            "Could not load featured creators.";
          featuredStatusMessageElement.classList.remove("hidden");
        }

        if (FEATURED_NPUBS.length) {
          (async () => {
            try {
              const controller = new AbortController();
              const refreshed = await Promise.all(
                FEATURED_NPUBS.map(async (identifier) => {
                  try {
                    const items = await fetchCreatorsFromDiscovery(
                      identifier,
                      controller.signal,
                    );
                    const built = buildProfilesFromResults(items);
                    return built[0] ?? null;
                  } catch (error) {
                    if (error?.name === "AbortError") {
                      return null;
                    }
                    console.warn(
                      "Failed to refresh featured creator",
                      identifier,
                      error,
                    );
                    return null;
                  }
                }),
              );

              const valid = refreshed.filter((profile) => profile !== null);
              if (valid.length) {
                renderProfiles(valid, featuredCreatorsGridElement, true);
                localStorage.setItem(
                  CACHE_KEY,
                  JSON.stringify({ timestamp: Date.now(), profiles: valid }),
                );
                featuredStatusMessageElement.classList.add("hidden");
              }
            } catch (error) {
              console.warn("Featured discovery refresh failed", error);
            }
          })();
        }

        const debouncedSearchHandler = debounce(handleSearch, 500);
        searchInputElement.addEventListener("input", (event) => {
          debouncedSearchHandler(event.target.value ?? "");
        });

        retryButtonElement.addEventListener("click", () => {
          if (lastSearchQuery) {
            handleSearch(lastSearchQuery);
          }
        });

        window.addEventListener("message", (event) => {
          if (event.data?.type === "prefillSearch" && event.data.npub) {
            searchInputElement.value = event.data.npub;
            handleSearch(event.data.npub);
          } else if (event.data?.type === "set-theme") {
            document.body.classList.toggle("dark", !!event.data.dark);
          }
        });
      }

      const stylesheet = document.querySelector(
        'link[rel="stylesheet"][href="find-creators.css"]',
      );

      function waitForStyles(cb) {
        if (!stylesheet || stylesheet.sheet) {
          cb();
        } else {
          stylesheet.addEventListener("load", cb, { once: true });
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => waitForStyles(init));
      } else {
        waitForStyles(init);
      }
    </script>
  </body>
</html>
